{"version":3,"file":"CMPTLoader-VEto4VOC.js","sources":["../../../src/core/renderer/loaders/CMPTLoaderBase.js","../../../src/three/renderer/loaders/CMPTLoader.js"],"sourcesContent":["// CMPT File Format\n// https://github.com/CesiumGS/3d-tiles/blob/master/specification/TileFormats/Composite/README.md\nimport { LoaderBase } from './LoaderBase.js';\nimport { readMagicBytes } from '../utilities/readMagicBytes.js';\n\nexport class CMPTLoaderBase extends LoaderBase {\n\n\tparse( buffer ) {\n\n\t\tconst dataView = new DataView( buffer );\n\n\t\t// 16-byte header\n\n\t\t// 4 bytes\n\t\tconst magic = readMagicBytes( dataView );\n\n\t\tconsole.assert( magic === 'cmpt', 'CMPTLoader: The magic bytes equal \"cmpt\".' );\n\n\t\t// 4 bytes\n\t\tconst version = dataView.getUint32( 4, true );\n\n\t\tconsole.assert( version === 1, 'CMPTLoader: The version listed in the header is \"1\".' );\n\n\t\t// 4 bytes\n\t\tconst byteLength = dataView.getUint32( 8, true );\n\n\t\tconsole.assert( byteLength === buffer.byteLength, 'CMPTLoader: The contents buffer length listed in the header matches the file.' );\n\n\t\t// 4 bytes\n\t\tconst tilesLength = dataView.getUint32( 12, true );\n\n\t\tconst tiles = [];\n\t\tlet offset = 16;\n\t\tfor ( let i = 0; i < tilesLength; i ++ ) {\n\n\t\t\tconst tileView = new DataView( buffer, offset, 12 );\n\t\t\tconst tileMagic = readMagicBytes( tileView );\n\t\t\tconst tileVersion = tileView.getUint32( 4, true );\n\t\t\tconst byteLength = tileView.getUint32( 8, true );\n\n\t\t\tconst tileBuffer = new Uint8Array( buffer, offset, byteLength );\n\t\t\ttiles.push( {\n\n\t\t\t\ttype: tileMagic,\n\t\t\t\tbuffer: tileBuffer,\n\t\t\t\tversion: tileVersion,\n\n\t\t\t} );\n\t\t\toffset += byteLength;\n\n\t\t}\n\n\t\treturn {\n\t\t\tversion,\n\t\t\ttiles,\n\t\t};\n\n\t}\n\n}\n\n","import { Group, DefaultLoadingManager, Matrix4 } from 'three';\nimport { CMPTLoaderBase } from '../../../core/renderer/loaders/CMPTLoaderBase.js';\nimport { B3DMLoader } from './B3DMLoader.js';\nimport { PNTSLoader } from './PNTSLoader.js';\nimport { I3DMLoader } from './I3DMLoader.js';\nimport { WGS84_ELLIPSOID } from '../math/GeoConstants.js';\n\nexport class CMPTLoader extends CMPTLoaderBase {\n\n\tconstructor( manager = DefaultLoadingManager ) {\n\n\t\tsuper();\n\t\tthis.manager = manager;\n\t\tthis.adjustmentTransform = new Matrix4();\n\t\tthis.ellipsoid = WGS84_ELLIPSOID.clone();\n\n\t}\n\n\tparse( buffer ) {\n\n\t\tconst result = super.parse( buffer );\n\t\tconst { manager, ellipsoid, adjustmentTransform } = this;\n\t\tconst promises = [];\n\n\t\tfor ( const i in result.tiles ) {\n\n\t\t\tconst { type, buffer } = result.tiles[ i ];\n\t\t\tswitch ( type ) {\n\n\t\t\t\tcase 'b3dm': {\n\n\t\t\t\t\tconst slicedBuffer = buffer.slice();\n\t\t\t\t\tconst loader = new B3DMLoader( manager );\n\t\t\t\t\tloader.workingPath = this.workingPath;\n\t\t\t\t\tloader.fetchOptions = this.fetchOptions;\n\t\t\t\t\tloader.adjustmentTransform.copy( adjustmentTransform );\n\n\t\t\t\t\tconst promise = loader.parse( slicedBuffer.buffer );\n\t\t\t\t\tpromises.push( promise );\n\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t\tcase 'pnts': {\n\n\t\t\t\t\tconst slicedBuffer = buffer.slice();\n\t\t\t\t\tconst loader = new PNTSLoader( manager );\n\t\t\t\t\tloader.workingPath = this.workingPath;\n\t\t\t\t\tloader.fetchOptions = this.fetchOptions;\n\n\t\t\t\t\tconst promise = loader.parse( slicedBuffer.buffer );\n\t\t\t\t\tpromises.push( promise );\n\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t\tcase 'i3dm': {\n\n\t\t\t\t\tconst slicedBuffer = buffer.slice();\n\t\t\t\t\tconst loader = new I3DMLoader( manager );\n\t\t\t\t\tloader.workingPath = this.workingPath;\n\t\t\t\t\tloader.fetchOptions = this.fetchOptions;\n\n\t\t\t\t\tloader.ellipsoid.copy( ellipsoid );\n\t\t\t\t\tloader.adjustmentTransform.copy( adjustmentTransform );\n\n\t\t\t\t\tconst promise = loader.parse( slicedBuffer.buffer );\n\t\t\t\t\tpromises.push( promise );\n\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t}\n\n\t\treturn Promise.all( promises ).then( results => {\n\n\t\t\tconst group = new Group();\n\t\t\tresults.forEach( result => {\n\n\t\t\t\tgroup.add( result.scene );\n\n\t\t\t} );\n\n\t\t\treturn {\n\n\t\t\t\ttiles: results,\n\t\t\t\tscene: group,\n\n\t\t\t};\n\n\t\t} );\n\n\t}\n\n}\n"],"names":["CMPTLoaderBase","LoaderBase","buffer","dataView","magic","readMagicBytes","version","byteLength","tilesLength","tiles","offset","i","tileView","tileMagic","tileVersion","tileBuffer","CMPTLoader","manager","DefaultLoadingManager","Matrix4","WGS84_ELLIPSOID","result","ellipsoid","adjustmentTransform","promises","type","slicedBuffer","loader","B3DMLoader","promise","PNTSLoader","I3DMLoader","results","group","Group"],"mappings":"oQAKO,MAAMA,UAAuBC,CAAW,CAE9C,MAAOC,EAAS,CAEf,MAAMC,EAAW,IAAI,SAAUD,CAAQ,EAKjCE,EAAQC,EAAgBF,CAAU,EAExC,QAAQ,OAAQC,IAAU,OAAQ,2CAA6C,EAG/E,MAAME,EAAUH,EAAS,UAAW,EAAG,EAAM,EAE7C,QAAQ,OAAQG,IAAY,EAAG,sDAAwD,EAGvF,MAAMC,EAAaJ,EAAS,UAAW,EAAG,EAAM,EAEhD,QAAQ,OAAQI,IAAeL,EAAO,WAAY,+EAAiF,EAGnI,MAAMM,EAAcL,EAAS,UAAW,GAAI,EAAM,EAE5CM,EAAQ,CAAE,EAChB,IAAIC,EAAS,GACb,QAAUC,EAAI,EAAGA,EAAIH,EAAaG,IAAO,CAExC,MAAMC,EAAW,IAAI,SAAUV,EAAQQ,EAAQ,EAAI,EAC7CG,EAAYR,EAAgBO,CAAU,EACtCE,EAAcF,EAAS,UAAW,EAAG,EAAM,EAC3CL,EAAaK,EAAS,UAAW,EAAG,EAAM,EAE1CG,EAAa,IAAI,WAAYb,EAAQQ,EAAQH,CAAY,EAC/DE,EAAM,KAAM,CAEX,KAAMI,EACN,OAAQE,EACR,QAASD,CAEb,CAAM,EACHJ,GAAUH,CAEb,CAEE,MAAO,CACN,QAAAD,EACA,MAAAG,CACA,CAEH,CAEA,CCpDO,MAAMO,UAAmBhB,CAAe,CAE9C,YAAaiB,EAAUC,EAAwB,CAE9C,MAAO,EACP,KAAK,QAAUD,EACf,KAAK,oBAAsB,IAAIE,EAC/B,KAAK,UAAYC,EAAgB,MAAO,CAE1C,CAEC,MAAOlB,EAAS,CAEf,MAAMmB,EAAS,MAAM,MAAOnB,CAAQ,EAC9B,CAAE,QAAAe,EAAS,UAAAK,EAAW,oBAAAC,CAAqB,EAAG,KAC9CC,EAAW,CAAE,EAEnB,UAAY,KAAKH,EAAO,MAAQ,CAE/B,KAAM,CAAE,KAAAI,EAAM,OAAAvB,CAAM,EAAKmB,EAAO,MAAO,CAAG,EAC1C,OAASI,EAAI,CAEZ,IAAK,OAAQ,CAEZ,MAAMC,EAAexB,EAAO,MAAO,EAC7ByB,EAAS,IAAIC,EAAYX,CAAS,EACxCU,EAAO,YAAc,KAAK,YAC1BA,EAAO,aAAe,KAAK,aAC3BA,EAAO,oBAAoB,KAAMJ,CAAqB,EAEtD,MAAMM,EAAUF,EAAO,MAAOD,EAAa,MAAQ,EACnDF,EAAS,KAAMK,CAAS,EACxB,KAEL,CAEI,IAAK,OAAQ,CAEZ,MAAMH,EAAexB,EAAO,MAAO,EAC7ByB,EAAS,IAAIG,EAAYb,CAAS,EACxCU,EAAO,YAAc,KAAK,YAC1BA,EAAO,aAAe,KAAK,aAE3B,MAAME,EAAUF,EAAO,MAAOD,EAAa,MAAQ,EACnDF,EAAS,KAAMK,CAAS,EACxB,KAEL,CAEI,IAAK,OAAQ,CAEZ,MAAMH,EAAexB,EAAO,MAAO,EAC7ByB,EAAS,IAAII,EAAYd,CAAS,EACxCU,EAAO,YAAc,KAAK,YAC1BA,EAAO,aAAe,KAAK,aAE3BA,EAAO,UAAU,KAAML,CAAW,EAClCK,EAAO,oBAAoB,KAAMJ,CAAqB,EAEtD,MAAMM,EAAUF,EAAO,MAAOD,EAAa,MAAQ,EACnDF,EAAS,KAAMK,CAAS,EACxB,KAEL,CAEA,CAEA,CAEE,OAAO,QAAQ,IAAKL,CAAQ,EAAG,KAAMQ,GAAW,CAE/C,MAAMC,EAAQ,IAAIC,EAClB,OAAAF,EAAQ,QAASX,GAAU,CAE1BY,EAAM,IAAKZ,EAAO,KAAO,CAE7B,CAAM,EAEI,CAEN,MAAOW,EACP,MAAOC,CAEP,CAEJ,CAAK,CAEL,CAEA"}