{"version":3,"file":"settling-DIEJznkR.js","sources":["../../../src/r3f/utilities/useMultipleRefs.js","../../../src/r3f/utilities/SceneObserver.js","../../../src/r3f/utilities/QueryManager.js","../../../src/r3f/components/SettledObjects.jsx","../../r3f/settling.jsx"],"sourcesContent":["import { useCallback } from 'react';\n\nexport function useMultipleRefs( ...refs ) {\n\n\treturn useCallback( target => {\n\n\t\trefs.forEach( ref => {\n\n\t\t\tif ( ref ) {\n\n\t\t\t\tif ( typeof ref === 'function' ) {\n\n\t\t\t\t\tref( target );\n\n\t\t\t\t} else {\n\n\t\t\t\t\tref.current = target;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t} );\n\n\t}, refs ); // eslint-disable-line\n\n}\n","import { EventDispatcher } from 'three';\n\nfunction traverse( root, callback ) {\n\n\tif ( callback( root ) ) {\n\n\t\treturn;\n\n\t}\n\n\troot.children.forEach( c => {\n\n\t\ttraverse( c, callback );\n\n\t} );\n\n}\n\nexport class SceneObserver extends EventDispatcher {\n\n\tconstructor() {\n\n\t\tsuper();\n\n\t\tthis.objects = new Set();\n\t\tthis.observed = new Set();\n\t\tthis._addedCallback = ( { child } ) => {\n\n\t\t\ttraverse( child, c => {\n\n\t\t\t\tif ( this.observed.has( c ) ) {\n\n\t\t\t\t\treturn true;\n\n\t\t\t\t} else {\n\n\t\t\t\t\tthis.objects.add( c );\n\t\t\t\t\tc.addEventListener( 'childadded', this._addedCallback );\n\t\t\t\t\tc.addEventListener( 'childremoved', this._removedCallback );\n\t\t\t\t\tthis.dispatchEvent( { type: 'childadded', child } );\n\t\t\t\t\treturn false;\n\n\t\t\t\t}\n\n\t\t\t} );\n\n\t\t};\n\n\t\tthis._removedCallback = ( { child } ) => {\n\n\t\t\ttraverse( child, c => {\n\n\t\t\t\tif ( this.observed.has( c ) ) {\n\n\t\t\t\t\treturn true;\n\n\t\t\t\t} else {\n\n\t\t\t\t\tthis.objects.delete( c );\n\t\t\t\t\tc.removeEventListener( 'childadded', this._addedCallback );\n\t\t\t\t\tc.removeEventListener( 'childremoved', this._removedCallback );\n\t\t\t\t\tthis.dispatchEvent( { type: 'childremoved', child } );\n\t\t\t\t\treturn false;\n\n\t\t\t\t}\n\n\t\t\t} );\n\n\t\t};\n\n\t}\n\n\tobserve( root ) {\n\n\t\tconst { observed } = this;\n\t\tthis._addedCallback( { child: root } );\n\t\tobserved.add( root );\n\n\t}\n\n\tunobserve( root ) {\n\n\t\tconst { observed } = this;\n\t\tobserved.delete( root );\n\t\tthis._removedCallback( { child: root } );\n\n\t}\n\n\tdispose() {\n\n\t\tthis.observed.forEach( root => {\n\n\t\t\tthis.unobserve( root );\n\n\t\t} );\n\n\t}\n\n}\n","import {\n\tRaycaster,\n\tMatrix4,\n\tEventDispatcher,\n\tVector3,\n\tRay,\n\tLine3,\n\tVector2,\n} from 'three';\nimport { SceneObserver } from './SceneObserver.js';\nimport { Ellipsoid } from '../../three/renderer/math/Ellipsoid.js';\n\nconst _raycaster = /* @__PURE__ */ new Raycaster();\nconst _line0 = /* @__PURE__ */ new Line3();\nconst _line1 = /* @__PURE__ */ new Line3();\nconst _params = /* @__PURE__ */ new Vector2();\nconst _direction = /* @__PURE__ */ new Vector3();\nconst _matrix = /* @__PURE__ */ new Matrix4();\nexport class QueryManager extends EventDispatcher {\n\n\tconstructor() {\n\n\t\tsuper();\n\n\t\t// settings\n\t\tthis.autoRun = true;\n\n\t\t// queries\n\t\tthis.queryMap = new Map();\n\t\tthis.index = 0;\n\n\t\t// jobs\n\t\tthis.queued = [];\n\t\tthis.scheduled = false;\n\t\tthis.duration = 1;\n\n\t\t// scene\n\t\tthis.objects = [];\n\t\tthis.observer = new SceneObserver();\n\t\tthis.ellipsoid = new Ellipsoid();\n\t\tthis.frame = new Matrix4();\n\n\t\t// cameras for sorting\n\t\tthis.cameras = new Set();\n\n\t\t// register to mark items as dirty\n\t\tconst queueAll = ( () => {\n\n\t\t\tlet queued = false;\n\t\t\treturn () => {\n\n\t\t\t\tif ( ! queued ) {\n\n\t\t\t\t\tqueued = true;\n\t\t\t\t\tqueueMicrotask( () => {\n\n\t\t\t\t\t\tthis.queryMap.forEach( item => this._enqueue( item ) );\n\t\t\t\t\t\tqueued = false;\n\n\t\t\t\t\t} );\n\n\t\t\t\t}\n\n\t\t\t};\n\n\t\t} )();\n\n\t\tthis.observer.addEventListener( 'childadded', queueAll );\n\t\tthis.observer.addEventListener( 'childremoved', queueAll );\n\n\t}\n\n\t// job runner\n\t_enqueue( info ) {\n\n\t\tif ( ! info.queued ) {\n\n\t\t\tthis.queued.push( info );\n\t\t\tinfo.queued = true;\n\t\t\tthis._scheduleRun();\n\n\t\t}\n\n\t}\n\n\t_runJobs() {\n\n\t\tconst { queued, cameras, duration } = this;\n\t\tconst start = performance.now();\n\n\t\t// Iterate over all cameras\n\t\tcameras.forEach( ( camera, c ) => {\n\n\t\t\t_matrix.copy( camera.matrixWorldInverse ).premultiply( camera.projectionMatrix );\n\t\t\t_direction.set( 0, 0, - 1 ).transformDirection( camera.matrixWorld );\n\n\t\t\t_line0.start.setFromMatrixPosition( camera.matrixWorld );\n\t\t\t_line0.end.addVectors( _direction, _line0.start );\n\n\t\t\tfor ( let i = 0, l = queued.length; i < l; i ++ ) {\n\n\t\t\t\tconst info = queued[ i ];\n\t\t\t\tconst { ray } = info;\n\n\t\t\t\t// save the values for sorting\n\t\t\t\tlet distance;\n\t\t\t\tlet inFrustum;\n\t\t\t\tif ( info.point === null ) {\n\n\t\t\t\t\t// prioritize displaying points that are from rays pointing in the same direction as\n\t\t\t\t\t// the camera. Find the distance between camera ray and projection ray:\n\t\t\t\t\t_line1.start.copy( ray.origin );\n\t\t\t\t\tray.at( 1, _line1.end );\n\t\t\t\t\tclosestPointLineToLine( _line0, _line1, _params );\n\n\t\t\t\t\tinfo.distance = _params.x * ( 1.0 - Math.abs( _direction.dot( ray.direction ) ) );\n\t\t\t\t\tinfo.inFrustum = true;\n\n\t\t\t\t} else {\n\n\t\t\t\t\t// if the point is within the frustum then prioritize it\n\t\t\t\t\tconst p = _line1.start;\n\t\t\t\t\tp.copy( info.point ).applyMatrix4( _matrix );\n\t\t\t\t\tif ( p.x > - 1 && p.x < 1 && p.y > - 1 && p.y < 1 && p.z > - 1 && p.z < 1 ) {\n\n\t\t\t\t\t\t// calculate the distance to the last hit point\n\t\t\t\t\t\tinfo.distance = p.subVectors( info.point, _line0.start ).dot( _direction );\n\t\t\t\t\t\tinfo.inFrustum = true;\n\n\t\t\t\t\t} else {\n\n\t\t\t\t\t\tinfo.distance = 0;\n\t\t\t\t\t\tinfo.inFrustum = false;\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t\tif ( c === 0 ) {\n\n\t\t\t\t\tinfo.distance = distance;\n\t\t\t\t\tinfo.inFrustum = inFrustum;\n\n\t\t\t\t} else {\n\n\t\t\t\t\tinfo.inFrustum = info.inFrustum || inFrustum;\n\t\t\t\t\tinfo.distance = Math.min( info.distance, distance );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t} );\n\n\t\t// sort the items if necessary\n\t\tif ( cameras.length !== 0 ) {\n\n\t\t\tqueued.sort( ( a, b ) => {\n\n\t\t\t\tif ( ( a.point === null ) !== ( b.point === null ) ) {\n\n\t\t\t\t\treturn a.point === null ? 1 : - 1;\n\n\t\t\t\t} else if ( a.inFrustum !== b.inFrustum ) {\n\n\t\t\t\t\treturn a.inFrustum ? 1 : - 1;\n\n\t\t\t\t} else if ( ( a.distance < 0 ) !== ( b.distance < 0 ) ) {\n\n\t\t\t\t\treturn a.distance < 0 ? - 1 : 1;\n\n\t\t\t\t} else {\n\n\t\t\t\t\treturn b.distance - a.distance;\n\n\t\t\t\t}\n\n\t\t\t} );\n\n\t\t}\n\n\t\t// update all the positions\n\t\twhile ( queued.length !== 0 && performance.now() - start < duration ) {\n\n\t\t\tconst item = queued.pop();\n\t\t\titem.queued = false;\n\t\t\tthis._updateQuery( item );\n\n\t\t}\n\n\t\tif ( queued.length !== 0 ) {\n\n\t\t\tthis._scheduleRun();\n\n\t\t}\n\n\t}\n\n\t_scheduleRun() {\n\n\t\tif ( this.autoRun && ! this.scheduled ) {\n\n\t\t\tthis.scheduled = true;\n\t\t\trequestAnimationFrame( () => {\n\n\t\t\t\tthis.scheduled = false;\n\t\t\t\tthis._runJobs();\n\n\t\t\t} );\n\n\t\t}\n\n\t}\n\n\t_updateQuery( item ) {\n\n\t\t_raycaster.ray.copy( item.ray );\n\t\t_raycaster.far = 'lat' in item ? 1e4 + Math.max( ...this.ellipsoid.radius ) : Infinity;\n\n\t\t// save the last hit point for sorting\n\t\tconst hit = _raycaster.intersectObjects( this.objects )[ 0 ] || null;\n\t\tif ( hit !== null ) {\n\n\t\t\tif ( item.point === null ) {\n\n\t\t\t\titem.point = hit.point.clone();\n\n\t\t\t} else {\n\n\t\t\t\titem.point.copy( hit.point );\n\n\t\t\t}\n\n\t\t}\n\n\t\titem.callback( hit );\n\n\t}\n\n\t// add and remove cameras used for sorting\n\taddCamera( camera ) {\n\n\t\tconst { queryMap, cameras } = this;\n\t\tcameras.add( camera );\n\t\tqueryMap.forEach( o => this._enqueue( o ) );\n\n\t}\n\n\tdeleteCamera( camera ) {\n\n\t\tconst { cameras } = this;\n\t\tcameras.delete( camera );\n\n\t}\n\n\t// run the given item index if possible\n\trunIfNeeded( index ) {\n\n\t\tconst { queryMap, queued } = this;\n\t\tconst item = queryMap.get( index );\n\t\tif ( item.queued ) {\n\n\t\t\tthis._updateQuery( item );\n\t\t\titem.queued = false;\n\t\t\tqueued.splice( queued.indexOf( item ), 1 );\n\n\t\t}\n\n\t}\n\n\t// set the scene used for query\n\tsetScene( ...objects ) {\n\n\t\tconst { observer } = this;\n\t\tobserver.dispose();\n\t\tobjects.forEach( o => observer.observe( o ) );\n\t\tthis.objects = objects;\n\t\tthis._scheduleRun();\n\n\t}\n\n\t// update the ellipsoid and frame based on a tiles renderer, updating the item rays only if necessary\n\tsetEllipsoidFromTilesRenderer( tilesRenderer ) {\n\n\t\tconst { queryMap, ellipsoid, frame } = this;\n\t\tif (\n\t\t\t! ellipsoid.radius.equals( tilesRenderer.ellipsoid.radius ) ||\n\t\t\t! frame.equals( tilesRenderer.group.matrixWorld )\n\t\t) {\n\n\t\t\tellipsoid.copy( tilesRenderer.ellipsoid );\n\t\t\tframe.copy( tilesRenderer.group.matrixWorld );\n\n\t\t\t// update the query rays for any item specified via lat / lon\n\t\t\tqueryMap.forEach( o => {\n\n\t\t\t\tif ( 'lat' in o ) {\n\n\t\t\t\t\tconst { lat, lon, ray } = o;\n\t\t\t\t\tellipsoid.getCartographicToPosition( lat, lon, 1e4, ray.origin ).applyMatrix4( frame );\n\t\t\t\t\tellipsoid.getCartographicToNormal( lat, lon, ray.direction ).transformDirection( frame ).multiplyScalar( - 1 );\n\n\t\t\t\t}\n\n\t\t\t\tthis._enqueue( o );\n\n\t\t\t} );\n\n\n\t\t}\n\n\t}\n\n\t// register query callbacks\n\tregisterRayQuery( ray, callback ) {\n\n\t\tconst index = this.index ++;\n\t\tconst item = {\n\t\t\tray: ray.clone(),\n\t\t\tcallback,\n\t\t\tqueued: false,\n\t\t\tdistance: - 1,\n\t\t\tpoint: null,\n\t\t};\n\n\t\tthis.queryMap.set( index, item );\n\t\tthis._enqueue( item );\n\t\treturn index;\n\n\t}\n\n\tregisterLatLonQuery( lat, lon, callback ) {\n\n\t\tconst { ellipsoid, frame } = this;\n\t\tconst index = this.index ++;\n\n\t\tconst ray = new Ray();\n\t\tellipsoid.getCartographicToPosition( lat, lon, 1e4, ray.origin ).applyMatrix4( frame );\n\t\tellipsoid.getCartographicToNormal( lat, lon, ray.direction ).transformDirection( frame ).multiplyScalar( - 1 );\n\n\t\tconst item = {\n\t\t\tray: ray.clone(),\n\t\t\tlat, lon,\n\t\t\tcallback,\n\t\t\tqueued: false,\n\t\t\tdistance: - 1,\n\t\t\tpoint: null,\n\t\t};\n\n\t\tthis.queryMap.set( index, item );\n\t\tthis._enqueue( item );\n\t\treturn index;\n\n\t}\n\n\tunregisterQuery( index ) {\n\n\t\tconst { queued, queryMap } = this;\n\t\tconst item = queryMap.get( index );\n\t\tqueryMap.delete( index );\n\n\t\tif ( item && item.queued ) {\n\n\t\t\titem.queued = false;\n\t\t\tqueued.splice( queued.indexOf( item ), 1 );\n\n\t\t}\n\n\t}\n\n\t// dispose of everything\n\tdispose() {\n\n\t\tthis.queryMap.clear();\n\t\tthis.queued.length = 0;\n\t\tthis.objects.length = 0;\n\t\tthis.observer.dispose();\n\n\t}\n\n}\n\n// copied from three-mesh-bvh\nconst closestPointLineToLine = ( function () {\n\n\t// https://github.com/juj/MathGeoLib/blob/master/src/Geometry/Line.cpp#L56\n\tconst dir1 = new Vector3();\n\tconst dir2 = new Vector3();\n\tconst v02 = new Vector3();\n\treturn function closestPointLineToLine( l1, l2, result ) {\n\n\t\tconst v0 = l1.start;\n\t\tconst v10 = dir1;\n\t\tconst v2 = l2.start;\n\t\tconst v32 = dir2;\n\n\t\tv02.subVectors( v0, v2 );\n\t\tdir1.subVectors( l1.end, l1.start );\n\t\tdir2.subVectors( l2.end, l2.start );\n\n\t\t// float d0232 = v02.Dot(v32);\n\t\tconst d0232 = v02.dot( v32 );\n\n\t\t// float d3210 = v32.Dot(v10);\n\t\tconst d3210 = v32.dot( v10 );\n\n\t\t// float d3232 = v32.Dot(v32);\n\t\tconst d3232 = v32.dot( v32 );\n\n\t\t// float d0210 = v02.Dot(v10);\n\t\tconst d0210 = v02.dot( v10 );\n\n\t\t// float d1010 = v10.Dot(v10);\n\t\tconst d1010 = v10.dot( v10 );\n\n\t\t// float denom = d1010*d3232 - d3210*d3210;\n\t\tconst denom = d1010 * d3232 - d3210 * d3210;\n\n\t\tlet d, d2;\n\t\tif ( denom !== 0 ) {\n\n\t\t\td = ( d0232 * d3210 - d0210 * d3232 ) / denom;\n\n\t\t} else {\n\n\t\t\td = 0;\n\n\t\t}\n\n\t\td2 = ( d0232 + d * d3210 ) / d3232; // eslint-disable-line\n\n\t\tresult.x = d;\n\t\tresult.y = d2;\n\n\t};\n\n} )();\n","import { cloneElement, createContext, forwardRef, useCallback, useContext, useEffect, useMemo, useRef } from 'react';\nimport { useMultipleRefs } from '../utilities/useMultipleRefs.js';\nimport { TilesRendererContext } from './TilesRenderer.jsx';\nimport { QueryManager } from '../utilities/QueryManager.js';\nimport { useDeepOptions } from '../utilities/useOptions.js';\nimport { OBJECT_FRAME } from '../../three/renderer/math/Ellipsoid.js';\nimport { Matrix4, Ray, Vector3 } from 'three';\nimport { useFrame, useThree } from '@react-three/fiber';\nimport { useApplyRefs } from '../utilities/useApplyRefs.js';\n\nconst QueryManagerContext = createContext( null );\nconst _matrix = /* @__PURE__ */ new Matrix4();\nconst _ray = /* @__PURE__ */ new Ray();\n\nexport const AnimatedSettledObject = forwardRef( function AnimatedSettledObject( props, ref ) {\n\n\tconst {\n\t\tinterpolationFactor = 0.025,\n\t\tonQueryUpdate = null,\n\t\t...rest\n\t} = props;\n\n\tconst tiles = useContext( TilesRendererContext );\n\tconst queries = useContext( QueryManagerContext );\n\tconst invalidate = useThree( ( { invalidate } ) => invalidate );\n\tconst target = useMemo( () => new Vector3(), [] );\n\tconst isInitialized = useMemo( () => ( { value: false } ), [] );\n\tconst isTargetSet = useMemo( () => ( { value: false } ), [] );\n\tconst objectRef = useRef( null );\n\n\tconst queryCallback = useCallback( hit => {\n\n\t\tif ( tiles === null || hit === null || objectRef.current === null ) {\n\n\t\t\treturn;\n\n\t\t}\n\n\t\tconst { lat, lon, rayorigin, raydirection } = rest;\n\t\tif ( lat !== null && lon !== null ) {\n\n\t\t\ttarget.copy( hit.point );\n\t\t\tisTargetSet.value = true;\n\n\t\t\tqueries.ellipsoid.getObjectFrame( lat, lon, 0, 0, 0, 0, _matrix, OBJECT_FRAME ).premultiply( tiles.group.matrixWorld );\n\t\t\tobjectRef.current.quaternion.setFromRotationMatrix( _matrix );\n\t\t\tinvalidate();\n\n\t\t} else if ( rayorigin !== null && raydirection !== null ) {\n\n\t\t\ttarget.copy( hit.point );\n\t\t\tisTargetSet.value = true;\n\n\t\t\tobjectRef.current.quaternion.identity();\n\t\t\tinvalidate();\n\n\t\t}\n\n\t\tif ( onQueryUpdate ) {\n\n\t\t\tonQueryUpdate( hit );\n\n\t\t}\n\n\t}, [ invalidate, isTargetSet, queries.ellipsoid, rest, target, tiles, onQueryUpdate ] );\n\n\t// interpolate the point position\n\tuseFrame( ( state, delta ) => {\n\n\t\tif ( objectRef.current ) {\n\n\t\t\tobjectRef.current.visible = isInitialized.value;\n\n\t\t}\n\n\t\tif ( objectRef.current && isTargetSet.value ) {\n\n\t\t\t// jump the point to the target if it's being set for the first time\n\t\t\tif ( isInitialized.value === false ) {\n\n\t\t\t\tisInitialized.value = true;\n\t\t\t\tobjectRef.current.position.copy( target );\n\n\t\t\t} else {\n\n\t\t\t\t// framerate independent lerp by Freya Holmer\n\t\t\t\tconst factor = 1 - 2 ** ( - delta / interpolationFactor );\n\t\t\t\tif ( objectRef.current.position.distanceToSquared( target ) > 1e-6 ) {\n\n\t\t\t\t\tobjectRef.current.position.lerp(\n\t\t\t\t\t\ttarget, interpolationFactor === 0 ? 1 : factor\n\t\t\t\t\t);\n\n\t\t\t\t\tinvalidate();\n\n\t\t\t\t} else {\n\n\t\t\t\t\tobjectRef.current.position.copy( target );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t}\n\n\t} );\n\n\treturn (\n\t\t<SettledObject\n\t\t\tref={ useMultipleRefs( objectRef, ref ) }\n\t\t\tonQueryUpdate={ queryCallback }\n\t\t\t{ ...rest }\n\t\t/>\n\t);\n\n} );\n\n// Object that updates its \"settled\" state\nexport const SettledObject = forwardRef( function SettledObject( props, ref ) {\n\n\tconst {\n\t\tcomponent = <group />,\n\t\tlat = null,\n\t\tlon = null,\n\t\trayorigin = null,\n\t\traydirection = null,\n\t\tonQueryUpdate = null,\n\n\t\t...rest\n\t} = props;\n\n\tconst objectRef = useRef( null );\n\tconst tiles = useContext( TilesRendererContext );\n\tconst queries = useContext( QueryManagerContext );\n\tconst invalidate = useThree( ( { invalidate } ) => invalidate );\n\tconst target = useMemo( () => new Vector3(), [] );\n\n\tuseEffect( () => {\n\n\t\tconst callback = hit => {\n\n\t\t\tif ( onQueryUpdate ) {\n\n\t\t\t\tonQueryUpdate( hit );\n\n\t\t\t} else if ( tiles && hit !== null && objectRef.current !== null ) {\n\n\t\t\t\tif ( lat !== null && lon !== null ) {\n\n\t\t\t\t\tobjectRef.current.position.copy( hit.point );\n\t\t\t\t\tqueries.ellipsoid.getObjectFrame( lat, lon, 0, 0, 0, 0, _matrix, OBJECT_FRAME ).premultiply( tiles.group.matrixWorld );\n\t\t\t\t\tobjectRef.current.quaternion.setFromRotationMatrix( _matrix );\n\t\t\t\t\tinvalidate();\n\n\t\t\t\t} else if ( rayorigin !== null && raydirection !== null ) {\n\n\t\t\t\t\tobjectRef.current.position.copy( hit.point );\n\t\t\t\t\tobjectRef.current.quaternion.identity();\n\t\t\t\t\tinvalidate();\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t};\n\n\t\tif ( lat !== null && lon !== null ) {\n\n\t\t\tconst index = queries.registerLatLonQuery( lat, lon, callback );\n\t\t\treturn () => queries.unregisterQuery( index );\n\n\t\t} else if ( rayorigin !== null && raydirection !== null ) {\n\n\t\t\t_ray.origin.copy( rayorigin );\n\t\t\t_ray.direction.copy( raydirection );\n\t\t\tconst index = queries.registerRayQuery( _ray, callback );\n\t\t\treturn () => queries.unregisterQuery( index );\n\n\t\t}\n\n\t}, [ lat, lon, rayorigin, raydirection, queries, tiles, invalidate, target, onQueryUpdate ] );\n\n\treturn cloneElement( component, { ...rest, ref: useMultipleRefs( objectRef, ref ), raycast: () => false } );\n\n} );\n\nexport const SettledObjects = forwardRef( function SettledObjects( props, ref ) {\n\n\tconst threeScene = useThree( ( { scene } ) => scene );\n\tconst {\n\t\tscene = threeScene,\n\t\tchildren,\n\t\t...rest\n\t} = props;\n\n\tconst tiles = useContext( TilesRendererContext );\n\tconst queries = useMemo( () => new QueryManager(), [] );\n\tconst camera = useThree( ( { camera } ) => camera );\n\n\tuseDeepOptions( queries, rest );\n\n\tuseEffect( () => {\n\n\t\treturn () => queries.dispose();\n\n\t}, [ queries ] );\n\n\tuseEffect( () => {\n\n\t\tqueries.setScene( ...( Array.isArray( scene ) ? scene : [ scene ] ) );\n\n\t}, [ queries, scene ] );\n\n\tuseEffect( () => {\n\n\t\tqueries.addCamera( camera );\n\n\t}, [ queries, camera ] );\n\n\tuseFrame( () => {\n\n\t\tif ( tiles ) {\n\n\t\t\tqueries.setEllipsoidFromTilesRenderer( tiles );\n\n\t\t}\n\n\t} );\n\n\t// assign ref\n\tuseApplyRefs( queries, ref );\n\n\treturn (\n\t\t<QueryManagerContext.Provider value={ queries }>\n\t\t\t<group matrixAutoUpdate={ false } matrixWorldAutoUpdate={ false }>\n\t\t\t\t{ children }\n\t\t\t</group>\n\t\t</QueryManagerContext.Provider>\n\t);\n\n} );\n","import { StrictMode, useRef } from 'react';\nimport { createRoot } from 'react-dom/client';\n\n// TilesRenderer, controls and attribution imports\nimport {\n\tTilesPlugin,\n\tTilesRenderer,\n\tTilesAttributionOverlay,\n\tGlobeControls,\n\tCompassGizmo,\n\tSettledObjects,\n\tAnimatedSettledObject,\n} from '3d-tiles-renderer/r3f';\n\n// Plugins\nimport {\n\tCesiumIonAuthPlugin,\n\tUpdateOnChangePlugin,\n\tTileCompressionPlugin,\n\tTilesFadePlugin,\n\tGLTFExtensionsPlugin,\n} from '3d-tiles-renderer/plugins';\nimport { DRACOLoader } from 'three/examples/jsm/loaders/DRACOLoader.js';\n\n// R3F, DREI and LEVA imports\nimport { Canvas, useFrame } from '@react-three/fiber';\nimport { Environment } from '@react-three/drei';\nimport { useControls } from 'leva';\nimport { MathUtils, Vector3 } from 'three';\nimport { TilesLoadingBar } from './components/TilesLoadingBar.jsx';\nimport { CameraViewTransition } from './components/CameraViewTransition.jsx';\n\nconst dracoLoader = new DRACOLoader().setDecoderPath( 'https://www.gstatic.com/draco/v1/decoders/' );\nconst vec1 = new Vector3();\nconst vec2 = new Vector3();\n\nfunction Pin( props ) {\n\n\tconst ref = useRef();\n\tuseFrame( ( { camera } ) => {\n\n\t\tconst pin = ref.current;\n\t\tlet scale;\n\t\tif ( camera.isPerspectiveCamera ) {\n\n\t\t\tvec1.setFromMatrixPosition( camera.matrixWorld );\n\t\t\tvec2.setFromMatrixPosition( pin.matrixWorld );\n\n\t\t\tconst distance = vec1.distanceTo( vec2 );\n\t\t\tscale = 0.05 * distance * Math.atan( camera.fov * MathUtils.DEG2RAD );\n\n\t\t} else {\n\n\t\t\tscale = ( camera.top - camera.bottom ) * 0.05 / camera.zoom;\n\n\t\t}\n\n\t\tscale = Math.min( Math.max( scale, 100 ), 200000 );\n\t\tpin.scale.setScalar( scale * 0.5 );\n\n\t} );\n\n\treturn (\n\t\t<AnimatedSettledObject ref={ ref } { ...props }>\n\t\t\t<mesh position-y={ 1.25 } scale={ 0.5 }>\n\t\t\t\t<sphereGeometry />\n\t\t\t\t<meshStandardMaterial color={ 0xf44336 } emissive={ 0xf44336 } emissiveIntensity={ 0.25 } />\n\t\t\t</mesh>\n\t\t\t<mesh position-y={ 0.5 } scale={ [ 0.1, 1, 0.1 ] }>\n\t\t\t\t<cylinderGeometry />\n\t\t\t\t<meshStandardMaterial color={ 0xf44336 } emissive={ 0xf44336 } emissiveIntensity={ 0.25 } />\n\t\t\t</mesh>\n\t\t</AnimatedSettledObject>\n\t);\n\n}\n\nfunction App() {\n\n\tconst levaParams = {\n\t\tortho: false,\n\t};\n\n\t// TODO: the renderer is rerendering due to floating point issues\n\t// - see if we should trigger an invalidate on tiles plugin add and params change\n\t// - see if we need to trigger a force update on plugin add for the UpdateOnChange plugin\n\n\tconst pins = new Array( 500 ).fill().map( ( e, i ) => {\n\n\t\tconst lat = - Math.PI / 2 + Math.PI * i / 500;\n\t\tconst lon = i;\n\n\t\treturn <Pin\n\t\t\tkey={ i }\n\t\t\tlat={ lat }\n\t\t\tlon={ lon }\n\t\t\tscale={ 0.1 }\n\t\t/>;\n\n\t} );\n\n\tconst { ortho } = useControls( levaParams );\n\treturn (\n\t\t<Canvas\n\t\t\tframeloop='demand'\n\t\t\tcamera={ {\n\t\t\t\tposition: [ 0, 0.5 * 1e7, 1.5 * 1e7 ],\n\t\t\t} }\n\t\t\tstyle={ {\n\t\t\t\twidth: '100%',\n\t\t\t\theight: '100%',\n\t\t\t\tposition: 'absolute',\n\t\t\t\tmargin: 0,\n\t\t\t\tleft: 0,\n\t\t\t\ttop: 0,\n\t\t\t} }\n\t\t\tflat\n\t\t>\n\t\t\t<color attach=\"background\" args={ [ 0x111111 ] } />\n\n\t\t\t<TilesRenderer group={ { rotation: [ - Math.PI / 2, 0, 0 ] } }>\n\t\t\t\t<TilesPlugin plugin={ CesiumIonAuthPlugin } args={ { apiToken: import.meta.env.VITE_ION_KEY, assetId: '2275207', autoRefreshToken: true } } />\n\t\t\t\t<TilesPlugin plugin={ GLTFExtensionsPlugin } dracoLoader={ dracoLoader } />\n\t\t\t\t<TilesPlugin plugin={ TileCompressionPlugin } />\n\t\t\t\t<TilesPlugin plugin={ UpdateOnChangePlugin } />\n\t\t\t\t<TilesPlugin plugin={ TilesFadePlugin } />\n\n\t\t\t\t{/* Controls */}\n\t\t\t\t<GlobeControls enableDamping={ true } />\n\t\t\t\t<CameraViewTransition mode={ ortho ? 'orthographic' : 'perspective' } />\n\n\t\t\t\t{/* Attributions */}\n\t\t\t\t<TilesAttributionOverlay />\n\n\t\t\t\t{/* Add compass gizmo */}\n\t\t\t\t<CompassGizmo />\n\n\t\t\t\t<TilesLoadingBar />\n\n\t\t\t\t<SettledObjects>{ pins }</SettledObjects>\n\t\t\t</TilesRenderer>\n\n\t\t\t{/* other r3f staging */}\n\t\t\t<Environment\n\t\t\t\tpreset=\"sunset\"\n\t\t\t\tbackgroundBlurriness={ 0.9 }\n\t\t\t\tenvironmentIntensity={ 1 }\n\t\t\t/>\n\t\t</Canvas>\n\t);\n\n}\n\ncreateRoot( document.getElementById( 'root' ) ).render(\n\t<StrictMode>\n\t\t<App />\n\t</StrictMode>,\n);\n\n"],"names":["useMultipleRefs","refs","useCallback","target","ref","traverse","root","callback","c","SceneObserver","EventDispatcher","child","observed","_raycaster","Raycaster","_line0","Line3","_line1","_params","Vector2","_direction","Vector3","_matrix","Matrix4","QueryManager","Ellipsoid","queueAll","queued","item","info","cameras","duration","start","camera","i","l","ray","distance","inFrustum","closestPointLineToLine","p","a","b","hit","queryMap","o","index","objects","observer","tilesRenderer","ellipsoid","frame","lat","lon","Ray","dir1","dir2","v02","l1","l2","result","v0","v10","v2","v32","d0232","d3210","d3232","d0210","denom","d","d2","QueryManagerContext","createContext","_ray","AnimatedSettledObject","forwardRef","props","interpolationFactor","onQueryUpdate","rest","tiles","useContext","TilesRendererContext","queries","invalidate","useThree","useMemo","isInitialized","isTargetSet","objectRef","useRef","queryCallback","rayorigin","raydirection","OBJECT_FRAME","useFrame","state","delta","factor","jsx","SettledObject","component","useEffect","cloneElement","SettledObjects","threeScene","scene","children","useDeepOptions","useApplyRefs","dracoLoader","DRACOLoader","vec1","vec2","Pin","pin","scale","MathUtils","jsxs","App","levaParams","pins","e","ortho","useControls","Canvas","TilesRenderer","TilesPlugin","CesiumIonAuthPlugin","GLTFExtensionsPlugin","TileCompressionPlugin","UpdateOnChangePlugin","TilesFadePlugin","GlobeControls","CameraViewTransition","TilesAttributionOverlay","CompassGizmo","TilesLoadingBar","Environment","createRoot","StrictMode"],"mappings":"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"}