{"version":3,"file":"loadRegion-DZFeH_ch.js","sources":["../../../src/three/plugins/LoadRegionPlugin.js","../../loadRegion.js"],"sourcesContent":["import { Ray, Sphere } from 'three';\nimport { OBB } from '../../three/renderer/math/OBB.js';\n\nexport class LoadRegionPlugin {\n\n\tconstructor() {\n\n\t\tthis.name = 'LOAD_REGION_PLUGIN';\n\t\tthis.regions = [];\n\t\tthis.tiles = null;\n\n\t}\n\n\tinit( tiles ) {\n\n\t\tthis.tiles = tiles;\n\n\t}\n\n\taddRegion( region ) {\n\n\t\tif ( this.regions.indexOf( region ) === - 1 ) {\n\n\t\t\tthis.regions.push( region );\n\n\t\t}\n\n\t}\n\n\tremoveRegion( region ) {\n\n\t\tconst index = this.regions.indexOf( region );\n\t\tif ( index !== - 1 ) {\n\n\t\t\tthis.regions.splice( index, 1 );\n\n\t\t}\n\n\t}\n\n\thasRegion( region ) {\n\n\t\treturn this.regions.indexOf( region ) !== - 1;\n\n\t}\n\n\tclearRegions() {\n\n\t\tthis.regions = [];\n\n\t}\n\n\tcalculateTileViewError( tile, target ) {\n\n\t\tconst boundingVolume = tile.cached.boundingVolume;\n\t\tconst { regions, tiles } = this;\n\n\t\tlet visible = false;\n\t\tlet maxError = - Infinity;\n\t\tfor ( const region of regions ) {\n\n\t\t\tconst intersects = region.intersectsTile( boundingVolume, tile, tiles );\n\t\t\tif ( intersects ) {\n\n\t\t\t\tvisible = true;\n\t\t\t\tmaxError = Math.max( region.calculateError( tile, tiles ), maxError );\n\n\t\t\t}\n\n\t\t}\n\n\t\ttarget.inView = visible;\n\t\ttarget.error = maxError;\n\n\t}\n\n\tdispose() {\n\n\t\tthis.regions = [];\n\n\t}\n\n}\n\n// Definitions of predefined regions\nexport class BaseRegion {\n\n\tconstructor( errorTarget = 10 ) {\n\n\t\tthis.errorTarget = errorTarget;\n\n\t}\n\n\tintersectsTile() {}\n\n\tcalculateError( tile, tilesRenderer ) {\n\n\t\treturn tile.geometricError - this.errorTarget + tilesRenderer.errorTarget;\n\n\t}\n\n}\n\nexport class SphereRegion extends BaseRegion {\n\n\tconstructor( errorTarget = 10, sphere = new Sphere() ) {\n\n\t\tsuper( errorTarget );\n\t\tthis.sphere = sphere.clone();\n\n\t}\n\n\tintersectsTile( boundingVolume ) {\n\n\t\treturn boundingVolume.intersectsSphere( this.sphere );\n\n\t}\n\n}\n\nexport class RayRegion extends BaseRegion {\n\n\tconstructor( errorTarget = 10, ray = new Ray() ) {\n\n\t\tsuper( errorTarget );\n\t\tthis.ray = ray.clone();\n\n\t}\n\n\tintersectsTile( boundingVolume ) {\n\n\t\treturn boundingVolume.intersectsRay( this.ray );\n\n\t}\n\n}\n\nexport class OBBRegion extends BaseRegion {\n\n\tconstructor( errorTarget = 10, obb = new OBB() ) {\n\n\t\tsuper( errorTarget );\n\t\tthis.obb = obb.clone();\n\t\tthis.obb.update();\n\n\t}\n\n\tintersectsTile( boundingVolume ) {\n\n\t\treturn boundingVolume.intersectsOBB( this.obb );\n\n\t}\n\n}\n","import { EnvironmentControls, TilesRenderer } from '3d-tiles-renderer';\nimport {\n\tDebugTilesPlugin,\n\tLoadRegionPlugin,\n\tRayRegion,\n\tOBBRegion,\n\tSphereRegion,\n} from '3d-tiles-renderer/plugins';\nimport {\n\tScene,\n\tWebGLRenderer,\n\tPerspectiveCamera,\n\tMesh,\n\tVector3,\n\tSphereGeometry,\n\tBoxGeometry,\n\tClock,\n\tLine,\n} from 'three';\nimport { GUI } from 'three/examples/jsm/libs/lil-gui.module.min.js';\n\nlet camera, controls, scene, renderer, tiles;\nlet rayRegion, sphereRegion, boxRegion;\nlet sphereMesh, rayMesh, boxMesh;\nlet clock, time = 0;\n\nconst params = {\n\n\tanimate: true,\n\tregion: 'SPHERE',\n\tregionErrorTarget: 0.1,\n\tregionOnly: true,\n\tdisplayBoxBounds: false,\n\n};\n\ninit();\nanimate();\n\nfunction init() {\n\n\tscene = new Scene();\n\n\t// primary camera view\n\trenderer = new WebGLRenderer( { antialias: true } );\n\trenderer.setPixelRatio( window.devicePixelRatio );\n\trenderer.setSize( window.innerWidth, window.innerHeight );\n\trenderer.setClearColor( 0x151c1f );\n\n\tdocument.body.appendChild( renderer.domElement );\n\trenderer.domElement.tabIndex = 1;\n\n\t// update the camera\n\tcamera = new PerspectiveCamera(\n\t\t60,\n\t\twindow.innerWidth / window.innerHeight,\n\t\t1,\n\t\t100000\n\t);\n\tcamera.position.set( 100, 100, 100 );\n\tcamera.lookAt( 0, 0, 0 );\n\tscene.add( camera );\n\n\t// clock\n\tclock = new Clock();\n\n\t// init tiles\n\ttiles = new TilesRenderer( 'https://raw.githubusercontent.com/NASA-AMMOS/3DTilesSampleData/master/msl-dingo-gap/0528_0260184_to_s64o256_colorize/0528_0260184_to_s64o256_colorize/0528_0260184_to_s64o256_colorize_tileset.json' );\n\ttiles.registerPlugin( new DebugTilesPlugin() );\n\ttiles.registerPlugin( new LoadRegionPlugin() );\n\ttiles.group.rotation.x = Math.PI / 2;\n\tscene.add( tiles.group );\n\n\t// controls\n\tcontrols = new EnvironmentControls( tiles.group, camera, renderer.domElement );\n\tcontrols.enableDamping = true;\n\n\t// initialize regions\n\trayRegion = new RayRegion();\n\tsphereRegion = new SphereRegion();\n\tsphereRegion.sphere.radius = 15;\n\tboxRegion = new OBBRegion();\n\tboxRegion.obb.box.min = new Vector3( - 50, - 50, - 5 );\n\tboxRegion.obb.box.max = new Vector3( 50, 50, 5 );\n\n\t// initialize region meshes\n\tsphereMesh = new Mesh( new SphereGeometry() );\n\tsphereMesh.material.transparent = true;\n\tsphereMesh.material.opacity = 0.25;\n\n\tboxMesh = new Mesh( new BoxGeometry() );\n\tboxMesh.material.transparent = true;\n\tboxMesh.material.opacity = 0.25;\n\n\trayMesh = new Line();\n\trayMesh.geometry.setFromPoints( [ new Vector3(), new Vector3( 0, - 1000, 0 ) ] );\n\trayMesh.material.opacity = 0.5;\n\trayMesh.material.transparent = true;\n\n\t// update the region to display\n\tupdateRegion( params.region );\n\n\t// update camera parameters\n\tonWindowResize();\n\twindow.addEventListener( 'resize', onWindowResize, false );\n\n\t// GUI\n\tconst gui = new GUI();\n\tgui.width = 300;\n\tgui.add( params, 'region', [ 'SPHERE', 'BOX', 'RAY' ] ).onChange( updateRegion );\n\tgui.add( params, 'regionErrorTarget' ).min( 0 ).max( 1 );\n\tgui.add( params, 'animate' );\n\tgui.add( params, 'regionOnly' ).onChange( v => {\n\n\t\tif ( ! v ) {\n\n\t\t\ttiles.setCamera( camera );\n\t\t\tonWindowResize();\n\n\t\t} else {\n\n\t\t\ttiles.deleteCamera( camera );\n\n\t\t}\n\n\t} );\n\tgui.add( params, 'displayBoxBounds' );\n\n\tgui.open();\n\n}\n\nfunction onWindowResize() {\n\n\tcamera.aspect = window.innerWidth / window.innerHeight;\n\trenderer.setSize( window.innerWidth, window.innerHeight );\n\tcamera.updateProjectionMatrix();\n\trenderer.setPixelRatio( window.devicePixelRatio * 1 );\n\ttiles.setResolutionFromRenderer( camera, renderer );\n\n}\n\nfunction updateRegion( region ) {\n\n\tconst plugin = tiles.getPluginByName( 'LOAD_REGION_PLUGIN' );\n\tplugin.clearRegions();\n\tscene.remove( rayMesh, sphereMesh, boxMesh );\n\n\tif ( region === 'SPHERE' ) {\n\n\t\tplugin.addRegion( sphereRegion );\n\t\tscene.add( sphereMesh );\n\n\t} else if ( region === 'RAY' ) {\n\n\t\tplugin.addRegion( rayRegion );\n\t\tscene.add( rayMesh );\n\n\t} else if ( region === 'BOX' ) {\n\n\t\tplugin.addRegion( boxRegion );\n\t\tscene.add( boxMesh );\n\n\t}\n\n}\n\n\nfunction animate() {\n\n\trequestAnimationFrame( animate );\n\n\t// update time step\n\tif ( params.animate ) {\n\n\t\ttime += clock.getDelta();\n\n\t} else {\n\n\t\tclock.getDelta();\n\n\t}\n\n\t// update debug plugin\n\tconst debugPlugin = tiles.getPluginByName( 'DEBUG_TILES_PLUGIN' );\n\tdebugPlugin.enabled = params.displayBoxBounds;\n\tdebugPlugin.displayBoxBounds = params.displayBoxBounds;\n\n\t// update the regions\n\tif ( params.region === 'SPHERE' ) {\n\n\t\tsphereMesh.position.set( Math.sin( time ) * 20, 0, Math.cos( time ) * 20 );\n\t\tsphereMesh.scale.setScalar( sphereRegion.sphere.radius );\n\n\t\tsphereRegion.errorTarget = params.regionErrorTarget;\n\t\tsphereRegion.sphere.center\n\t\t\t.copy( sphereMesh.position )\n\t\t\t.applyMatrix4( tiles.group.matrixWorldInverse );\n\n\t} else if ( params.region === 'RAY' ) {\n\n\t\trayMesh.position.set( Math.sin( time * 2 ) * 20, 50, Math.cos( time * 2 ) * 20 );\n\n\t\trayRegion.errorTarget = params.regionErrorTarget;\n\t\trayRegion.ray.direction\n\t\t\t.set( 0, - 1, 0 )\n\t\t\t.transformDirection( tiles.group.matrixWorldInverse );\n\t\trayRegion.ray.origin\n\t\t\t.copy( rayMesh.position )\n\t\t\t.applyMatrix4( tiles.group.matrixWorldInverse );\n\n\t} else if ( params.region === 'BOX' ) {\n\n\t\tboxMesh.scale.set( 50, 10, 50 );\n\t\tboxMesh.rotation.y = time;\n\t\tboxMesh.updateMatrixWorld();\n\t\tboxMesh.geometry.computeBoundingBox();\n\n\t\tboxRegion.errorTarget = params.regionErrorTarget;\n\t\tboxRegion.obb.box.copy( boxMesh.geometry.boundingBox );\n\t\tboxRegion.obb.transform.copy( boxMesh.matrixWorld ).premultiply( tiles.group.matrixWorldInverse );\n\t\tboxRegion.obb.update();\n\n\t}\n\n\t// update tiles\n\tcontrols.update();\n\tcamera.updateMatrixWorld();\n\ttiles.update();\n\n\t// render\n\trenderer.render( scene, camera );\n\n}\n"],"names":["LoadRegionPlugin","tiles","region","index","tile","target","boundingVolume","regions","visible","maxError","BaseRegion","errorTarget","tilesRenderer","SphereRegion","sphere","Sphere","RayRegion","ray","Ray","OBBRegion","obb","OBB","camera","controls","scene","renderer","rayRegion","sphereRegion","boxRegion","sphereMesh","rayMesh","boxMesh","clock","time","params","init","animate","Scene","WebGLRenderer","PerspectiveCamera","Clock","TilesRenderer","DebugTilesPlugin","EnvironmentControls","Vector3","Mesh","SphereGeometry","BoxGeometry","Line","updateRegion","onWindowResize","gui","GUI","v","plugin","debugPlugin"],"mappings":"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"}